# æ•°æ®åˆå¹¶

## æ•°æ®åˆå¹¶åœºæ™¯å’Œæ“ä½œ

åœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œéœ€è¦å°†å¤šä¸ªæ–‡æ¡£ã€æ•°æ®ï¼Œå¯èƒ½æ˜¯ Series æˆ– DataFrame æ‹¼åˆåœ¨ä¸€èµ·ï¼Œè¿›è¡Œå¤§æ•°æ®åˆ†æã€‚Pandas æä¾›çš„å„ç§åŠŸèƒ½è½»è€Œæ˜“ä¸¾åœ°è¿›è¡Œè¿™äº›å·¥ä½œã€‚

#### åº”ç”¨åœºæ™¯

åœ¨ä½œè€…æ¥çœ‹ï¼Œåœ¨ä»¥ä¸‹åœºæ™¯ä¸‹å¯èƒ½ä¼šéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‹¼æ¥ã€åˆå¹¶æ“ä½œï¼š

- æ—¥å¸¸å·¥ä½œä¸­ç”±å¤šæ–¹äº¤ä»˜çš„è¡¨æ ¼è¦åˆå¹¶æˆä¸€ä¸ªæ€»è¡¨æ ¼
- ä»æ•°æ®åº“å¯¼å‡ºæ•°æ®ï¼Œå•æ¬¡å¤ªå¤§ï¼Œå¤šæ¬¡å¯¼å‡ºåéœ€è¦åˆå¹¶
- æœ‰å¤šä¸ªæ•°æ®ï¼Œéœ€è¦åˆ¶å–å„è‡ªä¸­æœ‰ç”¨çš„ä¿¡æ¯ç»„æˆä¸€ä¸ªæ–°çš„è¡¨
- ç­‰ç­‰

#### æ“ä½œ

æ•°æ®çš„åˆå¹¶å…¶å®æœ‰åˆå¹¶ã€è¿æ¥ã€æ‹¼æ¥ç­‰å‡ ç§ï¼Œæœ€ç®€å•çš„æ˜¯è¿æ¥ã€‚è¿æ¥å­—æ®µç›¸åŒåªæ˜¯æŠŠæ–°çš„å†…å®¹è¿½åŠ åœ¨åè¾¹ã€‚åˆå¹¶å¯èƒ½æ˜¯ä¸åŒçš„åˆ—ï¼ŒæŠŠè¿™äº›åˆ—ç»„åˆåœ¨ä¸€èµ·å½¢æˆå¤šä¸ªåˆ—ã€‚è¿˜æœ‰ä¸€ç§æ˜¯æ··åˆçš„ï¼Œåœ¨ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼Œåˆå¹¶è¿‡ç¨‹ä¸­è¿˜éœ€è¦åšäº›è®¡ç®—ã€‚

## æ•°æ®è¿æ¥ [concat](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.concat.html?highlight=concat#pandas.concat)

Pandas æ•°æ®çš„è¿æ¥å¯ä»¥å®ç°çºµå‘å’Œæ¨ªå‘è¿æ¥ï¼Œå°†æ•°æ®è¿æ¥åä¼šå½¢æˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œ Series æˆ– DataFrameã€‚è¿æ¥æ˜¯æœ€å¸¸ç”¨çš„å¤šä¸ªæ•°æ®åˆå¹¶æ“ä½œã€‚

`pd.concat()` æ˜¯ä¸“é—¨ç”¨äºæ•°æ®è¿æ¥åˆå¹¶çš„å‡½æ•°ï¼Œå®ƒå¯ä»¥æ²¿ç€è¡Œæˆ–è€…åˆ—è¿›è¡Œæ“ä½œï¼ŒåŒæ—¶å¯ä»¥æŒ‡å®šéåˆå¹¶è½´çš„åˆå¹¶æ–¹å¼ï¼ˆåˆé›†ã€äº¤é›†ç­‰ï¼‰ã€‚å¯ä»¥è¯¦ç»†å‚é˜…[pd.concat API è¯´æ˜](https://www.gairuo.com/p/pandas-concat)ã€‚

#### æ•°æ®å‡†å¤‡

ä»¥ä¸‹æœ‰ä¸‰ä¸ª df ï¼Œåç»­çš„æ“ä½œæˆ‘ä»¬å°†å¯¹ä»–ä»¬è¿›è¡Œåˆå¹¶å¤„ç†ã€‚

```python
df1 = pd.DataFrame({'A': ['A0', 'A1', 'A2', 'A3'],
                    'B': ['B0', 'B1', 'B2', 'B3'],
                    'C': ['C0', 'C1', 'C2', 'C3'],
                    'D': ['D0', 'D1', 'D2', 'D3']},
                   index=[0, 1, 2, 3])


df2 = pd.DataFrame({'A': ['A4', 'A5', 'A6', 'A7'],
                    'B': ['B4', 'B5', 'B6', 'B7'],
                    'C': ['C4', 'C5', 'C6', 'C7'],
                    'D': ['D4', 'D5', 'D6', 'D7']},
                   index=[4, 5, 6, 7])


df3 = pd.DataFrame({'A': ['A8', 'A9', 'A10', 'A11'],
                    'B': ['B8', 'B9', 'B10', 'B11'],
                    'C': ['C8', 'C9', 'C10', 'C11'],
                    'D': ['D8', 'D9', 'D10', 'D11']},
                   index=[8, 9, 10, 11])
```

#### åŸºæœ¬è¿æ¥

å°†ä¸‰ä¸ªæœ‰ç›¸åŒåˆ—çš„è¡¨åˆå¹¶åˆ°ä¸€èµ·ï¼Œå¹¶ä½¿ç”¨æ–°çš„è‡ªç„¶ç´¢å¼•ï¼š

```python
frames = [df1, df2, df3]
df = pd.concat(frames)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/04/merging_concat_basic.png)

#### æŒ‡å®šç´¢å¼•

æˆ‘ä»¬å¯ä»¥å†ç»™æ¯ä¸ªè¡¨ç»™ä¸€ä¸ªä¸€çº§ç´¢å¼•ï¼Œå½¢æˆå¤šå±‚ç´¢å¼•ï¼š

```
df = pd.concat(frames, keys=['x', 'y', 'z'])
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_keys.png)

```python
df.loc['y'] # çœ‹ä¸€çº§ç´¢å¼• y
'''
    A   B   C   D
4  A4  B4  C4  D4
5  A5  B5  C5  D5
6  A6  B6  C6  D6
7  A7  B7  C7  D7
'''
```

#### å¿½ç•¥ç´¢å¼•

åœ¨åˆå¹¶ä¸ä¿ç•™åŸç´¢å¼•ï¼Œå¯ç”¨æ–°çš„è‡ªç„¶ç´¢å¼•ï¼š

```python
result = pd.concat([df1, df4], ignore_index=True, sort=False)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_ignore_index.png)

#### æŒ‰åˆ—è¿æ¥

æŒ‰åˆ—è¿›è¡Œè¿æ¥ï¼Œæ²¡æœ‰çš„å€¼ä¸ºç©ºï¼š

```python
df4 = pd.DataFrame({'B': ['B2', 'B3', 'B6', 'B7'],
                    'D': ['D2', 'D3', 'D6', 'D7'],
                    'F': ['F2', 'F3', 'F6', 'F7']},
                   index=[2, 3, 6, 7])
df = pd.concat([df1, df4], axis=1, sort=False)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_axis1.png)

#### å–äº¤é›†

ä»¥ä¸Šè¿æ¥åå¾—åˆ°äº†ä¸¤ä¸ªè¡¨å†…å®¹çš„å¹¶é›†ï¼ˆé»˜è®¤æ˜¯ `join ='outer'`ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦äº¤é›†å‘¢ï¼Ÿ

```python
df = pd.concat([df1, df4], axis=1, join='inner')
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_axis1_inner.png)

å¯è§åªå°†ä»¥æœ‰å…±åŒç´¢å¼•çš„å†…å®¹è¿›è¡Œäº†åˆå¹¶ã€‚

#### åªå–æŒ‡å®šç´¢å¼•å†…å®¹

å¦‚æœæˆ‘ä»¬åªéœ€è¦ç¬¬ä¸€å¼ è¡¨ç´¢å¼•çš„å†…å®¹ï¼Œå¯ä»¥ï¼š

```python
# ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•æ•ˆæœä¸€æ ·
pd.concat([df1, df4], axis=1).reindex(df1.index)
pd.concat([df1, df4.reindex(df1.index)], axis=1)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_axis1_join_axes.png)

#### ä¸åºåˆ—åˆå¹¶

ä¸ç”¨ç»´åº¦çš„æ•°æ®ä¹Ÿå¯ä»¥åˆå¹¶ï¼Œdf å’Œ s åˆå¹¶ï¼š

```python
s1 = pd.Series(['X0', 'X1', 'X2', 'X3'], name='X')
df = pd.concat([df1, s1], axis=1)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_mixed_ndim.png)

ä½†æ˜¯ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ df.assign() æ¥å®šä¹‰ä¸€ä¸ªæ–°åˆ—ã€‚

å¦‚æœåºåˆ—æ²¡åç§°ï¼Œä¼šè‡ªåŠ¨ç»™å†™ 012 ä¹‹ç±»çš„è‡ªç„¶ç´¢å¼•åç§°ï¼š

```python
s2 = pd.Series(['_0', '_1', '_2', '_3'])
df = pd.concat([df1, s2, s2, s2], axis=1)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_unnamed_series.png)

`ignore_index=True` ä¼šå–æ¶ˆåŸæœ‰åˆ—åï¼š

```python
df = pd.concat([df1, s1], axis=1, ignore_index=True)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_series_ignore_index.png)

#### æŒ‡å®šæ–°ç´¢å¼•å

ä»¥ä¸‹æ•°æ®åˆå¹¶åçš„åˆ—åæœ‰ï¼š

```python
s3 = pd.Series([0, 1, 2, 3], name='foo')
s4 = pd.Series([0, 1, 2, 3])
s5 = pd.Series([0, 1, 4, 5])
pd.concat([s3, s4, s5], axis=1)
'''
   foo  0  1
0    0  0  0
1    1  1  1
2    2  2  4
3    3  3  5
'''
```

ç»™å®š keys ä¼šé‡‡ç”¨æ–°çš„åˆ—å:

```python
pd.concat([s3, s4, s5], axis=1, keys=['red', 'blue', 'yellow'])
'''
   red  blue  yellow
0    0     0       0
1    1     1       1
2    2     2       4
3    3     3       5
'''
```

å¦‚æœæ˜¯ df è¿æ¥è¡Œï¼Œåˆ™æŒ‡å®šä¸ºç´¢å¼•åï¼š

```python
df = pd.concat(frames, keys=['x', 'y', 'z'])
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_group_keys2.png)

ä¹Ÿå¯ä»¥ç”¨**å­—å…¸**å½¢å¼ï¼Œå®šä¹‰å„è‡ªè¡¨çš„ç´¢å¼•åç§°ï¼š

```python
pieces = {'x': df1, 'y': df2, 'z': df3}
df = pd.concat(pieces)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_dict.png)

**åªå–å­—å…¸ä¸­çš„éƒ¨åˆ†ï¼š**

```python
df = pd.concat(pieces, keys=['z', 'y'])
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_dict_keys.png)

å¤šå±‚æ•°æ®çš„ç´¢å¼•å¦‚ä¸‹ï¼š

```python
result.index.levels
# FrozenList([['z', 'y'], [4, 5, 6, 7, 8, 9, 10, 11]])
```

å¦‚æœå¸Œæœ›æŒ‡å®šå…¶ä»–çº§åˆ«ï¼ˆæœ‰æ—¶ä¼šè¿™æ ·ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨levelå‚æ•°æ¥æŒ‡å®šï¼š

```python
df = pd.concat(pieces, keys=['x', 'y', 'z'],
               levels=[['z', 'y', 'x', 'w']],
               names=['group_key'])
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_concat_dict_keys_names.png)

```python
df.index.levels
# FrozenList([['z', 'y', 'x', 'w'], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]])
```

`pd.concat()` æ˜¯æœ€å¸¸ç”¨çš„æ•°æ®è¿æ¥å·¥å…·ï¼Œéœ€è¦ç†Ÿç»ƒæŒæ¡ã€‚

## å¤šæ–‡ä»¶æ•°æ®åˆå¹¶

å¤šæ–‡ä»¶åˆå¹¶åœ¨å®é™…å·¥ä½œä¸­è¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œæ±‡æ€»è¡¨å¾€å¾€è´¹æ—¶è´¹åŠ›ï¼Œå¦‚æœç”¨ä»£ç å¸®æˆ‘ä»¬å»åšå°±çœåŠ›å¾ˆå¤šï¼Œè€Œä¸”è¿˜å¯ä»¥å¤ç”¨ï¼Œå°±ä¼šèŠ‚çœå¤§é‡æ—¶é—´ã€‚

### å¤šæ–‡ä»¶åˆå¹¶

æœ€ç®€å•çš„æ–¹æ³•æ˜¯å…ˆå•ä¸ªæŠŠæ•°æ®å–å‡ºç°æ¥ï¼Œç„¶åè¿›è¡Œåˆå¹¶ã€‚

```python
df1 = pd.DataFrame(data1)
df2 = pd.read_excel('tmp.xlsx')
df3 = pd.read_csv('tmp.csv')

merged_df = pd.concat([df1, df2, df3])
```

æ³¨æ„ï¼Œä¸è¦ä¸€ä¸ªä¸€ä¸ªåœ°å»ç”¨ concatï¼Œè¿™æ ·æ€§èƒ½ä¼šå¾ˆå·®ï¼Œå¯ä»¥å…ˆæŠŠæ‰€æœ‰è¡¨æ ¼åŠ åˆ°åˆ—è¡¨é‡Œï¼Œä¸€æ¬¡æ€§åˆå¹¶ï¼š

```python
frames = [ process_your_file(f) for f in files ]
result = pd.concat(frames)
```

**ä¸€ä¸ªåŒ…å«å¤šä¸ª Sheet çš„ Excel åˆå¹¶æˆä¸€ä¸ª DataFrameï¼š**

```python
dfm = pd.read_excel('team.xlsx', sheet_name=None)
pd.concat(dfm.values())
pd.concat(dfm) # ä¿ç•™ Sheet åä½œä¸ºä¸€çº§ç´¢å¼•
```

### è¯»å–ç›®å½•æ–‡ä»¶

å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ¨èæ–¹æ³•ï¼š

```python
import glob
# å–å‡ºç›®å½•ä¸‹æ‰€æœ‰ xlsx æ ¼å¼æ–‡ä»¶
files = glob.glob("data/*.xlsx")
cols = ['è®°å½•ID', 'å¼€å§‹æ—¶é—´', 'åç§°'] # åªå–è¿™äº›åˆ—
# åˆ—è¡¨æ¨å¯¼å‡ºå¯¹è±¡
dflist = [pd.read_excel(i, usecols=cols) for i in files]
df = pd.concat(dflist) # åˆå¹¶
```

å…¶ä»–æ–¹æ³•ï¼š

```python
# å¤šä¸ªæ–‡ä»¶
pd.concat(map(pd.read_csv, ['data/d1.csv',
                            'data/d2.csv',
                            'data/d3.csv']))

pd.concat(map(pd.read_excel, ['data/d1.xlsx',
                              'data/d2.xlsx',
                              'data/d3.xlsx']))

# ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
from os import listdir
filepaths = [f for f in listdir("./data") if f.endswith('.csv')]
df = pd.concat(map(pd.read_csv, filepaths))

# æ–¹æ³• 2
import glob
df = pd.concat(map(pd.read_csv, glob.glob('data/*.csv')))
df = pd.concat(map(pd.read_excel, glob.glob('data/*.xlsx')))
```

### è¿½åŠ åˆ—åˆå¹¶

å¦‚æœéœ€è¦ä½¿ç”¨`pd.merge()`è¿½åŠ åˆ—åˆå¹¶æ—¶ï¼Œç”±äºæ­¤æ–¹æ³•åªèƒ½åˆå¹¶ä¸¤ä¸ª DataFrameï¼Œå› æ­¤å¯ä»¥ç”¨ reduce æ¥æ“ä½œå®Œæˆï¼š

```python
from functools import reduce

df = reduce(lambda a, b: pd.merge(a, b, on=['è®°å½•ID']), dflist)
```

åªè¦ç†Ÿç»ƒä½¿ç”¨å…¶ä¸­ä¸€ä¸ªæ–¹æ³•å°±è¡Œã€‚

## æ•°æ®è¿½åŠ  df.append

### è¯­æ³•ç»“æ„

## è¯­æ³•ç»“æ„

```python
df.append(self, other, ignore_index=False,
          verify_integrity=False, sort=False)
```

å…¶ä¸­ï¼š

- other æ˜¯å®ƒè¦è¿½åŠ çš„å…¶ä»– DataFrame æˆ–è€…ç±»ä¼¼åºåˆ—å†…å®¹
- ignore_index å¦‚æœä¸º True åˆ™é‡æ–°è¿›è¡Œè‡ªç„¶ç´¢å¼•
- verify_integrity å¦‚æœä¸º True åˆ™é‡åˆ°é‡å¤ç´¢å¼•å†…å®¹æ—¶æŠ¥é”™
- sort è¿›è¡Œæ’åº

### åŒç»“æ„

å°†åŒç»“æ„çš„æ•°æ®è¿½åŠ åœ¨åŸæ•°æ®åè¾¹ï¼š

```python
result = df1.append(df2)
```

![image-20230426150739502](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426150739502.png)

### ä¸åŒç»“æ„ 

ä¸åŒç»“æ„çš„è¿½åŠ ï¼Œæ²¡æœ‰çš„åˆ—ä¼šå¢åŠ ï¼Œæ²¡æœ‰å¯¹åº”å†…å®¹çš„ä¼šä¸ºç©ºï¼š

```python
result = df1.append(df4, sort=False)
```

![image-20230426150807084](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426150807084.png)

### è¿½åŠ åˆå¹¶å¤šä¸ª

å¯ä»¥å°†å¤šä¸ª df è¿½åŠ åˆ°åŸæ•°æ®ä¸­ï¼š

```python
result = df1.append([df2, df3])
```

![image-20230426150850934](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426150850934.png)

### å¿½ç•¥ç´¢å¼•

åœ¨åˆå¹¶ä¸ä¿ç•™åŸç´¢å¼•ï¼Œå¯ç”¨æ–°çš„è‡ªç„¶ç´¢å¼•ï¼š

```python
result = df1.append(df4, ignore_index=True, sort=False)
```

![pandas åˆå¹¶](https://www.gairuo.com/file/pic/2020/05/merging_append_ignore_index.png)

### è¿½åŠ åºåˆ—

```python
s2 = pd.Series(['X0', 'X1', 'X2', 'X3'],
               index=['A', 'B', 'C', 'D'])
result = df1.append(s2, ignore_index=True)
```

![image-20230426150953660](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426150953660.png)

### è¿½åŠ å­—å…¸åˆ—è¡¨

```python
dicts = [{'A': 1, 'B': 2, 'C': 3, 'X': 4},
         {'A': 5, 'B': 6, 'C': 7, 'Y': 8}]
result = df1.append(dicts, ignore_index=True, sort=False)
```

![image-20230426151335330](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426151335330.png)

### å…³äºåºŸå¼ƒ

åœ¨ pandas 1.4 ç‰ˆæœ¬ä¸­å®£å¸ƒ append() æ–¹æ³•å°†è¢«å¼ƒç”¨ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ä¼šè¿›è¡Œè­¦å‘Šï¼Œæç¤ºä½¿ç”¨ pandas.concat()ã€‚

ç¤¾åŒºè®¨è®ºåºŸå¼ƒ append() çš„ä¸»è¦åŸå› ä¸ºï¼š

- Python çš„ list æœ‰ append() æ–¹æ³•ï¼Œä½† DataFrame/Series çš„æ²¡æœ‰åšåŸåœ°æ“ä½œï¼Œæ˜¯ä¸€ä¸ªä¸å¥½çš„ç±»æ¯”
- pandas.concat() æ›´çµæ´»ï¼Œå®ƒæ”¯æŒ axisï¼Œä½¿ç±»ä¼¼æ“ä½œæ›´åŠ ç»Ÿä¸€
- concat å°†æ˜¯æ€§èƒ½æœ€å¥½çš„ï¼Œappend å¤ªæ…¢

æ›¿ä»£çš„æ“ä½œä¹Ÿå¯ä»¥æ˜¯ï¼š

```python
df.loc[len(df) + 1] = <new row>
df.loc[<new label>] = <new row>
```

å¦‚æœæƒ³ç”¨é“¾å¼ï¼Œå¯ä»¥ç”¨ pipe() è°ƒç”¨ï¼š

```python
df2 = pd.DataFrame({"name": ["tomato"], "image": ["ğŸ…"]})

(
    fruits.merge(veggies)
    .pipe(lambda df: pd.concat([df, df2], ignore_index=True))
)
```

### å‚è€ƒ

## è¿æ¥æ•°æ® [merge](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.merge.html?highlight=merge#pandas.DataFrame.merge)

### è¯­æ³•ç»“æ„

å¯ä»¥å°†ä¸¤ä¸ª DataFrame æˆ–è€… Series è¿›è¡Œè¿æ¥ï¼š

```python
pd.merge(left, right, how='inner', on=None, left_on=None, right_on=None,
         left_index=False, right_index=False, sort=True,
         suffixes=('_x', '_y'), copy=True, indicator=False,
         validate=None)
```

å¯ä»¥å®ç°ç±»ä¼¼ SQL çš„ join æ“ä½œï¼Œå‚æ•°ä¸ºï¼š

- howï¼šè¿æ¥æ–¹å¼ï¼Œé»˜è®¤ä¸ºinnerï¼Œå¯è®¾ä¸ºinner/outer/left/right
- onï¼šæ ¹æ®æŸä¸ªå­—æ®µè¿›è¡Œè¿æ¥ï¼Œå¿…é¡»å­˜åœ¨äºä¸¤ä¸ªDateFrameä¸­ï¼ˆè‹¥æœªåŒæ—¶å­˜åœ¨ï¼Œåˆ™éœ€è¦åˆ†åˆ«ä½¿ç”¨left_on å’Œ right_on æ¥è®¾ç½®ï¼‰
- left_onï¼šå·¦è¿æ¥ï¼Œä»¥DataFrame1ä¸­ç”¨ä½œè¿æ¥é”®çš„åˆ—
- right_onï¼šå³è¿æ¥ï¼Œä»¥DataFrame2ä¸­ç”¨ä½œè¿æ¥é”®çš„åˆ—
- left_indexï¼šbool, default Falseï¼Œå°†DataFrame1è¡Œç´¢å¼•ç”¨ä½œè¿æ¥é”®
- right_indexï¼šbool, default Falseï¼Œå°†DataFrame2è¡Œç´¢å¼•ç”¨ä½œè¿æ¥é”®
- sortï¼šæ ¹æ®è¿æ¥é”®å¯¹åˆå¹¶åçš„æ•°æ®è¿›è¡Œæ’åˆ—ï¼Œé»˜è®¤ä¸ºTrue
- suffixesï¼šå¯¹ä¸¤ä¸ªæ•°æ®é›†ä¸­å‡ºç°çš„é‡å¤åˆ—ï¼Œæ–°æ•°æ®é›†ä¸­åŠ ä¸Šåç¼€ _x, _y è¿›è¡ŒåŒºåˆ«

### è¿æ¥é”®

```python
left = pd.DataFrame({'key': ['K0', 'K1', 'K2', 'K3'],
                     'A': ['A0', 'A1', 'A2', 'A3'],
                     'B': ['B0', 'B1', 'B2', 'B3']})

right = pd.DataFrame({'key': ['K0', 'K1', 'K2', 'K3'],
                      'C': ['C0', 'C1', 'C2', 'C3'],
                      'D': ['D0', 'D1', 'D2', 'D3']})

pd.merge(left, right, on='key')
```

![pandas merge](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key.png)

`on` ä¸ºä¸¤ä¸ªæ•°æ®çš„è¿æ¥é”®ï¼Œéƒ½ä»¥ key ä¸ºæ ‡å‡†ã€‚

### å¤šä¸ªè¿æ¥é”®

æœ‰å¤šä¸ªè¿æ¥é”®ï¼Œå°†ä¸¤ä¸ªè¡¨æŒ‰å¤šä¸ªå…³é”®ç‚¹ï¼ˆäº¤å‰ç‚¹ï¼‰è¿æ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹how=â€œinnerâ€ï¼Œä¼šå¾—åˆ°ä¸€ä¸¤ä¸ªæ•°æ®çš„äº¤é›†ã€‚

```python
left = pd.DataFrame({'key1': ['K0', 'K0', 'K1', 'K2'],
                     'key2': ['K0', 'K1', 'K0', 'K1'],
                     'A': ['A0', 'A1', 'A2', 'A3'],
                     'B': ['B0', 'B1', 'B2', 'B3']})


right = pd.DataFrame({'key1': ['K0', 'K1', 'K1', 'K2'],
                      'key2': ['K0', 'K0', 'K0', 'K0'],
                      'C': ['C0', 'C1', 'C2', 'C3'],
                      'D': ['D0', 'D1', 'D2', 'D3']})

pd.merge(left, right, on=['key1', 'key2'])
```

![image-20230426152259768](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230426152259768.png)

key1 å’Œ key2 ç»„åˆåœ¨ä¸¤ä¸ªè¡¨é‡Œå…±æœ‰çš„ä¼šè¢«è¿æ¥ï¼Œä¸¤ä¸ªè¡¨éƒ½æœ‰ `(k1, k0)` ï¼Œå³è¡¨æœ‰ä¸¤ä¸ªï¼Œå·¦è¡¨æœ‰ä¸€ä¸ªï¼Œåˆå¹¶åå³è¡¨å…±åŒäº†å·¦è¡¨çš„å†…å®¹ã€‚

### è¿æ¥æ–¹æ³• how

`how` å‚æ•°å¯ä»¥æŒ‡å®šæ•°æ®ç”¨å“ªç§æ–¹æ³•è¿›è¡Œåˆå¹¶ï¼Œæ²¡æœ‰çš„å†…å®¹ä¼šä¸º NaNï¼š

```python
# ä»¥å·¦ä¸ºè¡¨åŸºè¡¨
pd.merge(left, right, how='left', on=['key1', 'key2'])
```

![pandas merge left](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key_left.png)

```python
# ä»¥å³ä¸ºè¡¨åŸºè¡¨
pd.merge(left, right, how='right', on=['key1', 'key2'])
```

![pandas merge right](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key_right.png)

```python
# å–ä¸¤ä¸ªè¡¨çš„åˆé›†
pd.merge(left, right, how='outer', on=['key1', 'key2'])
```

![pandas merge outer](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key_outer.png)

```python
# å–ä¸¤ä¸ªè¡¨çš„äº¤é›†
pd.merge(left, right, how='inner', on=['key1', 'key2'])
```

![pandas merge inner](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key_inner.png)

ä¸‹è¾¹æ˜¯ä¸€ä¸ªæœ‰é‡å¤è¿æ¥é”®çš„ä¾‹å­ï¼š

```python
left = pd.DataFrame({'A': [1, 2], 'B': [2, 2]})
right = pd.DataFrame({'A': [4, 5, 6], 'B': [2, 2, 2]})
pd.merge(left, right, on='B', how='outer')
```

![pandas merge key_dup](https://www.gairuo.com/file/pic/2020/05/merging_merge_on_key_dup.png)

### æ£€æŸ¥é‡å¤é”® validate

```python
# ä¸€å¯¹å¤šè¿æ¥
left = pd.DataFrame({'A' : [1,2], 'B' : [1, 2]})
right = pd.DataFrame({'A' : [4,5,6], 'B': [2, 2, 2]})
pd.merge(left, right, on='B', how='outer', validate="one_to_many")
```

å…¶ä»–çš„è¿˜æœ‰ï¼š

å¦‚æœæŒ‡å®šï¼Œåˆ™æ£€æŸ¥åˆå¹¶æ˜¯å¦ä¸ºæŒ‡å®šçš„ç±»å‹ï¼š

- â€œone_to_oneâ€ æˆ– â€œ1:1â€: æ£€æŸ¥åˆå¹¶é”®åœ¨å·¦å³æ•°æ®é›†ä¸­æ˜¯å¦å”¯ä¸€
- â€œone_to_manyâ€ æˆ– â€œ1:mâ€: æ£€æŸ¥åˆå¹¶é”®åœ¨å·¦æ•°æ®é›†ä¸­æ˜¯å¦å”¯ä¸€
- â€œmany_to_oneâ€ æˆ– â€œm:1â€: æ£€æŸ¥åˆå¹¶é”®åœ¨å³æ•°æ®é›†ä¸­æ˜¯å¦å”¯ä¸€
- â€œmany_to_manyâ€ æˆ– â€œm:mâ€: å…è®¸ï¼Œä½†ä¸ä¼šæ£€æŸ¥

### è¿æ¥æŒ‡ç¤º indicator

å¦‚æœè®¾ç½® indicator ä¸º True, åˆ™ä¼šå¢åŠ åä¸º `_merge` çš„ä¸€åˆ—ï¼Œæ˜¾ç¤ºè¿™åˆ—æ˜¯å¤šä½•è€Œæ¥ï¼Œ_merge åˆ—æœ‰å–ä¸‰ä¸ªå€¼ï¼š

- left_only åªåœ¨å·¦è¡¨ä¸­
- right_only åªåœ¨å³è¡¨ä¸­
- both ä¸¤ä¸ªè¡¨ä¸­éƒ½æœ‰

```python
pd.merge(left, right, on='B', how='outer', indicator=True)

'''
   A_x  B  A_y     _merge
0    1  1  NaN  left_only
1    2  2  4.0       both
2    2  2  5.0       both
3    2  2  6.0       both
'''
```

### join å¤šä¸ª dataframe

df.join(df2) å¯ä»¥è¿ç”¨å¯¹å¤šä¸ªæ•°æ®å®Œæˆåˆå¹¶æ‹¼æ¥ï¼š

```python
df.join(df2) # æŒ‰ç´¢å¼•è¿æ¥
left.join([right, right2]) # è¿æ¥å¤šä¸ªè¡¨
# æ”¯æŒçš„å‚æ•° lsuffix/rsuffix ä¸ºå·¦å³è¡¨åç¼€
df1.join(other, on=None, how='left', lsuffix='', rsuffix='', sort=False)
```

### å…¶ä»–æ“ä½œ

```python
# df ä¹Ÿæœ‰ merge æ–¹æ³•ï¼Œç”¨æˆ·ä¸ pd.merge ç›¸åŒ
left.merge(right, how='inner')
# æŒ‰ç´¢å¼•è¿æ¥
pd.merge(left, right, left_index=True, right_index=True, how='inner')
# åˆ—å’Œç´¢å¼•è¿æ¥
left.join(right, on=key_or_keys)
result = left.join(right, on=['key1', 'key2'])
pd.merge(left, right, left_on=key_or_keys, right_index=True,
      how='left', sort=False)

# è¿æ¥æ–¹å¼
result = left.join(right, how='inner')
# å–æ¶ˆç´¢å¼•æŒ‰åˆ—è¿æ¥
pd.merge(left.reset_index(), right.reset_index(),
         on=['key'], how='inner').set_index(['key', 'Y'])
```

## æ—¶åºæ•°æ®åˆå¹¶

### [pd.merge_ordered](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_ordered.html?highlight=merge_ordered#pandas.merge_ordered)

`pd.merge_ordered` å‡½æ•°å…è®¸ç»„åˆæ—¶é—´åºåˆ—å’Œå…¶ä»–æœ‰åºæ•°æ®ã€‚ ç‰¹åˆ«æ˜¯ï¼Œå®ƒå…·æœ‰å¯é€‰çš„fill_method å…³é”®å­—æ¥å¡«å……/æ’å…¥ä¸¢å¤±çš„æ•°æ®ï¼š

```python
left = pd.DataFrame({'k': ['K0', 'K1', 'K1', 'K2'],
                     'lv': [1, 2, 3, 4],
                     's': ['a', 'b', 'c', 'd']})

right = pd.DataFrame({'k': ['K1', 'K2', 'K4'],
                      'rv': [1, 2, 3]})

pd.merge_ordered(left, right, fill_method='ffill', left_by='s')
'''
     k   lv  s   rv
0   K0  1.0  a  NaN
1   K1  1.0  a  1.0
2   K2  1.0  a  2.0
3   K4  1.0  a  3.0
4   K1  2.0  b  1.0
5   K2  2.0  b  2.0
6   K4  2.0  b  3.0
7   K1  3.0  c  1.0
8   K2  3.0  c  2.0
9   K4  3.0  c  3.0
10  K1  NaN  d  1.0
11  K2  4.0  d  2.0
12  K4  4.0  d  3.0
'''
```

æŒ‰ç…§ s åˆ—çš„é¡ºåºè¿›è¡Œäº†æ’åºï¼Œå®ƒä¹Ÿé€‚ç”¨äºæ—¶é—´ç±»å‹çš„æ•°æ®ã€‚

æŒ‰ç…§left_byæ’åºæ—¶ï¼Œå¦å¤–ä¸¤åˆ—çš„æ•°æ®æ˜¯ k0, k1, k2, k4, k1,k2,k4, k1,k2,k4, k1,k2,k4,å®ƒä¼šä»¥sä¸ºåŸºå‡†ï¼Œæ¯æ¬¡å»rightæ‰¾ä¸å­˜åœ¨çš„åŠ ä¸Šå»ã€‚

### [pd.merge_asof](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html?highlight=merge_asof#pandas.merge_asof)

æ‰§è¡Œ asof åˆå¹¶ï¼ˆas of æ„ä¸ºè‡ªâ€¦â€¦èµ·ï¼›åˆ°â€¦æ—¶å€™ä¸ºæ­¢ï¼‰ï¼Œè¿™ç±»ä¼¼äºå·¦è¿æ¥ï¼Œåªæ˜¯æˆ‘ä»¬åŒ¹é…æœ€è¿‘çš„å…³é”®ç‚¹ï¼ˆon å‚æ•°æŒ‡å®šï¼‰è€Œä¸æ˜¯ç›¸ç­‰çš„å…³é”®ç‚¹ã€‚ä¸¤ä¸ª DataFrame å¿…é¡»æŒ‰é”®æ’åºã€‚

è¯­æ³•ä¸ºï¼š

```python
pd.merge_asof(left, right, on=None,
              left_on=None, right_on=None,
              left_index=False, right_index=False,
              by=None, left_by=None, right_by=None,
              suffixes=('_x', '_y'), tolerance=None,
              allow_exact_matches=True,
              direction='backward')
```

å…¶ä¸­ on å‚æ•°çš„å€¼ä»£è¡¨çš„åˆ—åï¼Œå¿…é¡»åœ¨ä¸¤ä¸ªæ•°æ®å¸§ä¸­éƒ½æ‰¾åˆ°ï¼Œå¿…é¡»å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚æ­¤å¤–ï¼Œè¿™å¿…é¡»æ˜¯å¯ä»¥æ•°å­—åŒ–çš„åˆ—ï¼Œå¦‚ datetimelikeï¼ˆæ—¶é—´çš„å„ç§ç±»å‹ï¼‰, integer, floatã€‚å¿…é¡»è¦ä¸ç»™å‡ºå‚æ•° On è¦ä¹ˆç»™å‡º left_on/right_onã€‚

å…ˆä¸Šä¸ªä¾‹å­ï¼š

```python
left = pd.DataFrame({'a': [1, 5, 10], 'left_val': ['a', 'b', 'c']})
left
'''    a left_val
0   1        a
1   5        b
2  10        c
'''

right = pd.DataFrame({'a': [1, 2, 3, 6, 7],
                      'right_val': [1, 2, 3, 6, 7]})
right
'''   a  right_val
0  1          1
1  2          2
2  3          3
3  6          6
4  7          7
'''

# æŒ‰ a è¿æ¥
pd.merge_asof(left, right, on='a')
'''    a left_val  right_val
0   1        a          1
1   5        b          3
2  10        c          7
'''
```

ä»¥ä¸Šä¾‹ä¸­å·¦è¡¨ï¼ˆåŸºå‡†è¡¨ï¼‰ä¸å³è¡¨æŒ‰å…±åŒçš„ a åˆ—è¿›è¡Œåˆå¹¶ï¼Œåœ¨æ‹¼åˆ right_val åˆ—æ—¶ï¼š

- a=1ï¼Œå³è¡¨æœ‰å¯¹åº”å€¼ï¼Œä¸º 1
- a=5ï¼Œå³è¡¨æ— å¯¹åº”å€¼ï¼Œç”±äºå‚æ•°é»˜è®¤ direction='backward' åˆ™â€œå‘åâ€æœç´¢é€‰æ‹©å³è¡¨ä¸­â€œonâ€é”®å°äºæˆ–ç­‰äºå·¦é”®çš„æœ€åä¸€è¡Œï¼Œä¸ 5 è¾ƒå°çš„æ˜¯ 3ï¼Œå– 3
- a=10ï¼Œå³è¡¨æ— å¯¹åº”å€¼ï¼ŒåŒä¸Šï¼Œä¸ 10 è¾ƒå°çš„æ˜¯ 7ï¼Œå– 7

å‚æ•° direction è¿˜å¯ä»¥å–ä»¥ä¸‹å€¼ï¼š

- â€œbackwardâ€ å‘åï¼Œæœç´¢é€‰æ‹©å³æ•°æ®ä¸­â€œonâ€é”®å°äºæˆ–ç­‰äºå·¦é”®çš„æœ€åä¸€è¡Œï¼Œæ¯”å®ƒå°çš„é‡Œè¾¹æœ€å¤§çš„ã€‚
- â€œforwardâ€ å‘å‰ï¼Œæœç´¢é€‰æ‹©å³ä¾§æ•°æ®ä¸­çš„ç¬¬ä¸€è¡Œï¼Œå…¶â€œonâ€é”®å¤§äºæˆ–ç­‰äºå·¦ä¾§çš„é”®ï¼Œæ¯”å®ƒå¤§çš„é‡Œè¾¹æœ€å¤§çš„ã€‚
- â€œnearestâ€ æœ€è¿‘ï¼Œæœç´¢é€‰æ‹©å³ä¾§æ•°æ®ä¸­çš„è¡Œï¼Œè¯¥è¡Œçš„â€œonâ€é”®åœ¨ç»å¯¹è·ç¦»ä¸Šæœ€æ¥è¿‘å·¦ä¾§çš„é”®ï¼Œå’Œå®ƒå·®å€¼ç»å¯¹å€¼æœ€å°çš„ã€‚

å‚æ•° direction çš„ä¾‹å­ï¼š

```
# å‘å‰
pd.merge_asof(left, right, on="a", direction="forward")
'''
    a left_val  right_val
0   1        a        1.0
1   5        b        6.0
2  10        c        NaN
'''

# é‚»è¿‘
pd.merge_asof(left, right, on="a", direction="nearest")
'''
    a left_val  right_val
0   1        a          1
1   5        b          6
2  10        c          7
'''
pd.merge_asof(left, right, on='a', allow_exact_matches=False)
'''    a left_val  right_val
0   1        a        NaN
1   5        b        3.0
2  10        c        7.0
'''
```

å‚æ•° allow_exact_matches çš„æ„æ€æ˜¯ï¼š

- å¦‚ä¸º Trueï¼ˆé»˜è®¤ï¼‰, å…è®¸ä¸ç›¸åŒçš„å€¼åŒ¹é…ï¼ˆå³å°äºæˆ–ç­‰äº/å¤§äºæˆ–ç­‰äºï¼‰
- å¦‚ä¸º False, ä¸åŒ¹é…ç›¸åŒçš„å€¼ï¼ˆå³ä¸¥æ ¼è¦æ±‚å°äº/å¤§äºï¼Œå°±æ˜¯ä¸èƒ½ç­‰äºï¼‰

ä¸Šä¾‹è®¾ç½®ä¸º Falseï¼Œa=1 æ—¶ï¼Œç”±äºå³è¡¨æœ‰åŒæ ·çš„å€¼ï¼Œå°±ä¸åŒ¹é…äº†ï¼Œç»™å‡ºäº†ä¸€ä¸ªç¼ºå¤±å€¼ã€‚

è¿™ä¸ªæ–¹æ³•ç»å¸¸ç”¨äºåˆå¹¶æ—¶é—´ç›¸å…³çš„æ•°æ®ï¼Œç”±äºæ—¶é—´æ•°æ®åœ¨åˆå¹¶æ—¶æœ‰ç»†å¾®çš„å·®åˆ«ï¼Œä¸èƒ½å®Œå…¨åŒ¹é…ï¼Œå°±éœ€è¦æ‰¾åˆ°é‚»è¿‘çš„å€¼ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯æ—¶é—´ç›¸å…³çš„æ¡ˆä¾‹ï¼š

```python
quotes
'''                     time ticker     bid     ask
0 2016-05-25 13:30:00.023   GOOG  720.50  720.93
1 2016-05-25 13:30:00.023   MSFT   51.95   51.96
2 2016-05-25 13:30:00.030   MSFT   51.97   51.98
3 2016-05-25 13:30:00.041   MSFT   51.99   52.00
4 2016-05-25 13:30:00.048   GOOG  720.50  720.93
5 2016-05-25 13:30:00.049   AAPL   97.99   98.01
6 2016-05-25 13:30:00.072   GOOG  720.50  720.88
7 2016-05-25 13:30:00.075   MSFT   52.01   52.03'''

trades
'''                     time ticker   price  quantity
0 2016-05-25 13:30:00.023   MSFT   51.95        75
1 2016-05-25 13:30:00.038   MSFT   51.95       155
2 2016-05-25 13:30:00.048   GOOG  720.77       100
3 2016-05-25 13:30:00.048   GOOG  720.92       100
4 2016-05-25 13:30:00.048   AAPL   98.00       100'''

pd.merge_asof(trades, quotes,
                      on='time',
                      by='ticker')
'''                     time ticker   price  quantity     bid     ask
0 2016-05-25 13:30:00.023   MSFT   51.95        75   51.95   51.96
1 2016-05-25 13:30:00.038   MSFT   51.95       155   51.97   51.98
2 2016-05-25 13:30:00.048   GOOG  720.77       100  720.50  720.93
3 2016-05-25 13:30:00.048   GOOG  720.92       100  720.50  720.93
4 2016-05-25 13:30:00.048   AAPL   98.00       100     NaN     NaN'''

pd.merge_asof(trades, quotes,
                      on='time',
                      by='ticker',
                      tolerance=pd.Timedelta('2ms'))
'''                     time ticker   price  quantity     bid     ask
0 2016-05-25 13:30:00.023   MSFT   51.95        75   51.95   51.96
1 2016-05-25 13:30:00.038   MSFT   51.95       155     NaN     NaN
2 2016-05-25 13:30:00.048   GOOG  720.77       100  720.50  720.93
3 2016-05-25 13:30:00.048   GOOG  720.92       100  720.50  720.93
4 2016-05-25 13:30:00.048   AAPL   98.00       100     NaN     NaN'''

pd.merge_asof(trades, quotes,
                      on='time',
                      by='ticker',
                      tolerance=pd.Timedelta('10ms'),
                      allow_exact_matches=False)
'''                     time ticker   price  quantity     bid     ask
0 2016-05-25 13:30:00.023   MSFT   51.95        75     NaN     NaN
1 2016-05-25 13:30:00.038   MSFT   51.95       155   51.97   51.98
2 2016-05-25 13:30:00.048   GOOG  720.77       100     NaN     NaN
3 2016-05-25 13:30:00.048   GOOG  720.92       100     NaN     NaN
4 2016-05-25 13:30:00.048   AAPL   98.00       100     NaN     NaN'''
```

tolerance å‚æ•°å¯ä¼ å…¥ä¸€ä¸ªæ—¶é•¿æ•°æ®ï¼ˆTimedeltaï¼Œåœ¨éæ—¶é—´æ•°æ®æƒ…å†µä¸‹å¯ä»¥ä¼ å…¥ä¸€ä¸ª intï¼‰ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå®¹æ˜“çš„å·®è·èŒƒå›´ï¼Œå¿…é¡»ä¸åˆå¹¶ç´¢å¼•å…¼å®¹ã€‚

## é€å…ƒç´ åˆå¹¶

### df.combine_first() [combine_first](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.combine_first.html?highlight=combine_first#pandas.DataFrame.combine_first)

ä½¿ç”¨ç›¸åŒä½ç½®çš„å€¼æ›´æ–°ç©ºå…ƒç´ ï¼Œå®ƒåªèƒ½æ˜¯ df1 æœ‰ç©ºå…ƒç´ æ—¶æ‰èƒ½è¢«æ›¿æ¢ï¼Œå¦‚æœæ•°æ®ç»“æ„ä¸ä¸€è‡´ï¼Œæ‰€å¾— DataFram eçš„è¡Œç´¢å¼•å’Œåˆ—ç´¢å¼•å°†æ˜¯ä¸¤è€…çš„å¹¶é›†ã€‚

```python
df1 = pd.DataFrame({'A': [None, 0], 'B': [None, 4]})
df2 = pd.DataFrame({'A': [1, 1], 'B': [3, 3]})
df1.combine_first(df2)
'''
     A    B
0  1.0  3.0
1  0.0  4.0
'''
```

åœ¨ä¸Šä¾‹ä¸­ï¼Œdf1 ä¸­çš„ A å’Œ B çš„ç©ºå€¼è¢« df2 ä¸­çš„ç›¸åŒä½ç½®å€¼æ›¿æ¢ã€‚

```python
df1 = pd.DataFrame({'A': [None, 0], 'B': [4, None]})
df2 = pd.DataFrame({'B': [3, 3], 'C': [1, 1]}, index=[1, 2])
df1.combine_first(df2)
'''
     A    B    C
0  NaN  4.0  NaN
1  0.0  3.0  1.0
2  NaN  3.0  1.0
'''
```

åœ¨ä¸Šä¾‹ä¸­ï¼Œdf1 ä¸­çš„ A ä¸­çš„ç©ºå€¼ç”±äºæ²¡æœ‰ç›¸åŒä½ç½®å€¼æ¥æ›¿æ¢ï¼Œä»ç„¶ä¸ºç©ºã€‚

### df.combine() [combine](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.combine.html?highlight=combine#pandas.DataFrame.combine)

å¯ä»¥ä¸å¦ä¸€ä¸ª DataFrame è¿›è¡ŒæŒ‰åˆ—ç»„åˆã€‚ä½¿ç”¨å‡½æ•°å°†ä¸€ä¸ª DataFrame ä¸å…¶ä»–DataFrameåˆå¹¶ï¼Œä»¥é€å…ƒç´ åˆå¹¶åˆ—ã€‚ æ‰€å¾— DataFrame çš„è¡Œç´¢å¼•å’Œåˆ—ç´¢å¼•å°†æ˜¯ä¸¤è€…çš„å¹¶é›†ã€‚

è¿™ä¸ªå‡½æ•°ä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ª df ä¸­å¯¹åº”çš„ seriesï¼Œ è®¡ç®—åè¿”å›ä¸€ä¸ª Series æˆ–è€…æ ‡é‡ã€‚

```python
df1 = pd.DataFrame({'A': [0, 0], 'B': [4, 4]})
df2 = pd.DataFrame({'A': [1, 1], 'B': [3, 3]})
# s1 åˆ—æ€»å’Œå¦‚æœå°äº s2åˆ—æ€»å’Œå– s1, å¦åˆ™å– s2
take_smaller = lambda s1, s2: s1 if s1.sum() < s2.sum() else s2
df1.combine(df2, take_smaller)
'''
A  B
0  0  3
1  0  3
'''
```

ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ numpy çš„å‡½æ•°ï¼š

```python
df1 = pd.DataFrame({'A': [5, 0], 'B': [2, 4]})
df2 = pd.DataFrame({'A': [1, 1], 'B': [3, 3]})
# æ¯ä¸ªå¯¹åº”å…ƒç´ ä¸­æœ€å°çš„
df1.combine(df2, np.minimum)
   A  B
0  1  2
1  0  3
```

å¯¹äºç©ºå€¼ç¼ºå¤±å€¼å¯ä»¥æŒ‡å®šå¡«å……å€¼ï¼Œå¡«å……å®Œåä»£å…¥è®¡ç®—ï¼š

```python
df1 = pd.DataFrame({'A': [0, 0], 'B': [None, 4]})
df2 = pd.DataFrame({'A': [1, 1], 'B': [3, 3]})
df1.combine(df2, take_smaller, fill_value=-5)
'''
A    B
0  0 -5.0
1  0  4.0'
''
```

ä½†æ˜¯ï¼Œå¦‚æœä¸¤ä¸ªæ•°æ®å¸§ä¸­çš„ç›¸åŒå…ƒç´ å‡ä¸ºâ€œæ— â€ï¼Œåˆ™å°†ä¿ç•™â€œæ— â€ï¼š

```python
df1 = pd.DataFrame({'A': [0, 0], 'B': [None, 4]})
df2 = pd.DataFrame({'A': [1, 1], 'B': [None, 3]})
df1.combine(df2, take_smaller, fill_value=-5)
'''
A    B
0  0 -5.0
1  0  3.0
'''
```

ä»¥ä¸‹æ˜¯è½´ä¸åŒæ—¶åˆå¹¶è¦†ç›–å’Œè¡Œä¸ºï¼Œå‡ä¼šä¸ºç©ºå€¼ã€‚

```python
df1 = pd.DataFrame({'A': [0, 0], 'B': [4, 4]})
df2 = pd.DataFrame({'B': [3, 3], 'C': [-10, 1], }, index=[1, 2])
df1.combine(df2, take_smaller)
'''
A    B     C
0  NaN  NaN   NaN
1  NaN  3.0 -10.0
2  NaN  3.0   1.0
'''
# overwrite ä¸å­˜åœ¨çš„åˆ—å°†ä¸è¢«NaNè¦†ç›–
df1.combine(df2, take_smaller, overwrite=False)
'''
A    B     C
0  0.0  NaN   NaN
1  0.0  3.0 -10.0
2  NaN  3.0   1.0
'''
```

ä»¥ä¸‹æ˜¯ä¸åŒè¡Œç´¢å¼•çš„ç¤ºä¾‹ï¼š

```python
df2 = pd.DataFrame({'B': [3, 3], 'C': [1, 1], }, index=[1, 2])
df2.combine(df1, take_smaller)
   A    B   C
0  0.0  NaN NaN
1  0.0  3.0 NaN
2  NaN  3.0 NaN

df2.combine(df1, take_smaller, overwrite=False)
     A    B   C
0  0.0  NaN NaN
1  0.0  3.0 1.0
2  NaN  3.0 1.0
```

### df.update()

ä½¿ç”¨æ¥è‡ªå¦ä¸€ä¸ª DataFrame çš„éNAå€¼è¿›è¡Œä¿®æ”¹ï¼ŒåŸ df ä¸ºè¢«æ›´æ–°ã€‚

```python
df = pd.DataFrame({'A': [1, 2, 3],
                   'B': [400, 500, 600]})
new_df = pd.DataFrame({'B': [4, 5, 6],
                       'C': [7, 8, 9]})
df.update(new_df)
df
   A  B
0  1  4
1  2  5
2  3  6
```

DataFrameçš„é•¿åº¦ä¸ä¼šå¢åŠ ï¼Œåªä¼šæ›´æ–°åŒ¹é…çš„ç´¢å¼•/åˆ—æ ‡ç­¾ä¸Šçš„å€¼ã€‚

```python
df = pd.DataFrame({'A': ['a', 'b', 'c'],
                   'B': ['x', 'y', 'z']})
new_df = pd.DataFrame({'B': ['d', 'e', 'f', 'g', 'h', 'i']})
df.update(new_df)
df
   A  B
0  a  d
1  b  e
2  c  f
```

å¯¹äºç³»åˆ—ï¼Œå¿…é¡»è®¾ç½®å…¶åç§°å±æ€§ã€‚

```python
df = pd.DataFrame({'A': ['a', 'b', 'c'],
                   'B': ['x', 'y', 'z']})
new_column = pd.Series(['d', 'e'], name='B', index=[0, 2])
df.update(new_column)
df
   A  B
0  a  d
1  b  y
2  c  e


df = pd.DataFrame({'A': ['a', 'b', 'c'],
                   'B': ['x', 'y', 'z']})
new_df = pd.DataFrame({'B': ['d', 'e']}, index=[1, 2])
df.update(new_df)
df
   A  B
0  a  x
1  b  d
2  c  e
```

å¦‚æœå…¶ä»–åŒ…å«NaNï¼Œåˆ™ç›¸åº”çš„å€¼ä¸ä¼šåœ¨åŸå§‹æ•°æ®å¸§ä¸­æ›´æ–°ã€‚

```python
df = pd.DataFrame({'A': [1, 2, 3],
                   'B': [400, 500, 600]})
new_df = pd.DataFrame({'B': [4, np.nan, 6]})
df.update(new_df)
df
   A      B
0  1    4.0
1  2  500.0
2  3    6.0
```

## ç›¸å…³å†…å®¹

## æ•°æ®å¯¹æ¯” [compare](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.compare.html?highlight=compare#pandas.DataFrame.compare)

df.compare() å’Œs.compare() æ–¹æ³•ä½¿æ‚¨å¯ä»¥åˆ†åˆ«æ¯”è¾ƒä¸¤ä¸ªDataFrame æˆ– Seriesï¼Œå¹¶æ€»ç»“å®ƒä»¬ä¹‹é—´çš„å·®å¼‚ã€‚V1.1.0 ä¸­æ·»åŠ äº†æ­¤åŠŸèƒ½ã€‚



### è¯­æ³•

è¯­æ³•å¦‚ä¸‹ï¼š

```python
pd.compare(other, align_axis=1, keep_shape=False, keep_equal=False)
```

å…¶ä¸­ï¼š

- otherï¼šè¢«å¯¹æ¯”çš„æ•°æ®
- align_axis=1ï¼šå·®å¼‚å †å åœ¨åˆ—/è¡Œä¸Š
- keep_shape=Falseï¼šä¸ä¿ç•™ç›¸ç­‰çš„å€¼
- keep_equal=Falseï¼šä¸ä¿ç•™æ‰€æœ‰åŸå§‹è¡Œå’Œåˆ—

### ç”¨æ³•

ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æƒ³è¦æ¯”è¾ƒä¸¤ä¸ªDataFrameå¹¶æ’å †å å®ƒä»¬çš„å·®å¼‚ã€‚



```python
df = pd.DataFrame(
    {
        "col1": ["a", "a", "b", "b", "a"],
        "col2": [1.0, 2.0, 3.0, np.nan, 5.0],
        "col3": [1.0, 2.0, 3.0, 4.0, 5.0]
    },
    columns=["col1", "col2", "col3"],
)
df
'''
  col1  col2  col3
0    a   1.0   1.0
1    a   2.0   2.0
2    b   3.0   3.0
3    b   NaN   4.0
4    a   5.0   5.0
'''

# å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ä»¥ä¾¿è¿›è¡Œå¯¹æ¯”
df2 = df.copy()
df2.loc[0, 'col1'] = 'c'
df2.loc[2, 'col3'] = 4.0

df2
'''
  col1  col2  col3
0    c   1.0   1.0
1    a   2.0   2.0
2    b   3.0   4.0
3    b   NaN   4.0
4    a   5.0   5.0
'''
```

åº”ç”¨å¯¹æ¯”ï¼š

```python
df.compare(df2)
'''
  col1       col3
  self other self other
0    a     c  NaN   NaN
2  NaN   NaN  3.0   4.0
'''
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸¤ä¸ªå¯¹åº”çš„å€¼ç›¸ç­‰ï¼Œå®ƒä»¬å°†æ˜¾ç¤ºä¸ºNaNã€‚ æ­¤å¤–ï¼Œå¦‚æœæ•´ä¸ªè¡Œ/åˆ—ä¸­çš„æ‰€æœ‰å€¼éƒ½å°†ä»ç»“æœä¸­çœç•¥ã€‚ å…¶ä½™å·®å¼‚å°†åœ¨åˆ—ä¸Šå¯¹é½ã€‚

### å…¶ä»–æ–¹æ³•

è¿˜å¯ä»¥ä¼ å…¥ä»¥ä¸‹å‚æ•°ï¼š

```python
df = pd.DataFrame(
    {
        "col1": ["a", "a", "b", "b", "a"],
        "col2": [1.0, 2.0, 3.0, np.nan, 5.0],
        "col3": [1.0, 2.0, 3.0, 4.0, 5.0]
    },
    columns=["col1", "col2", "col3"],
)

df
'''
  col1  col2  col3
0    a   1.0   1.0
1    a   2.0   2.0
2    b   3.0   3.0
3    b   NaN   4.0
4    a   5.0   5.0
'''
```

ä¿®æ”¹æ•°æ®ï¼Œæ–¹ä¾¿å¯¹æ¯”ï¼š

```python
df2 = df.copy()
df2.loc[0, 'col1'] = 'c'
df2.loc[2, 'col3'] = 4.0
df2
'''
  col1  col2  col3
0    c   1.0   1.0
1    a   2.0   2.0
2    b   3.0   4.0
3    b   NaN   4.0
4    a   5.0   5.0
'''
```

æ˜¾ç¤ºæœ‰å·®å¼‚çš„åˆ—ï¼š

```python
df.compare(df2)
'''
  col1       col3
  self other self other
0    a     c  NaN   NaN
2  NaN   NaN  3.0   4.0
'''
```

å°†å·®å¼‚å †å åœ¨è¡Œä¸Šï¼š

```python
df.compare(df2, align_axis=0)
'''
        col1  col3
0 self     a   NaN
  other    c   NaN
2 self   NaN   3.0
  other  NaN   4.0
'''
```

ä¿ç•™ç›¸ç­‰çš„å€¼ï¼š

```python
df.compare(df2, keep_equal=True)
'''
  col1       col3
  self other self other
0    a     c  1.0   1.0
2    b     b  3.0   4.0
'''
```

ä¿ç•™æ‰€æœ‰åŸå§‹è¡Œå’Œåˆ—ï¼š

```python
df.compare(df2, keep_shape=True)
'''
  col1       col2       col3
  self other self other self other
0    a     c  NaN   NaN  NaN   NaN
1  NaN   NaN  NaN   NaN  NaN   NaN
2  NaN   NaN  NaN   NaN  3.0   4.0
3  NaN   NaN  NaN   NaN  NaN   NaN
4  NaN   NaN  NaN   NaN  NaN   NaN
'''
```

ä¿ç•™æ‰€æœ‰åŸå§‹è¡Œå’Œåˆ—ä»¥åŠæ‰€æœ‰åŸå§‹å€¼ï¼š

```python
df.compare(df2, keep_shape=True, keep_equal=True)
'''
  col1       col2       col3
  self other self other self other
0    a     c  1.0   1.0  1.0   1.0
1    a     a  2.0   2.0  2.0   2.0
2    b     b  3.0   3.0  3.0   4.0
3    b     b  NaN   NaN  4.0   4.0
4    a     a  5.0   5.0  5.0   5.0
'''
```

### æ•°æ®ç›¸åŒ [equals](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.equals.html?highlight=equals#pandas.DataFrame.equals)

æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`df1.equals(df2)`æ¥å¯¹æ¯”ä¸¤ä¸ªæ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œæµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦åŒ…å«ç›¸åŒçš„å…ƒç´ ã€‚



æ­¤åŠŸèƒ½å…è®¸å°†ä¸¤ä¸ªSeriesæˆ–DataFrameç›¸äº’æ¯”è¾ƒï¼Œä»¥æŸ¥çœ‹å®ƒä»¬æ˜¯å¦å…·æœ‰ç›¸åŒçš„å½¢çŠ¶å’Œå…ƒç´ ã€‚ ç›¸åŒä½ç½®çš„NaNè¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ã€‚ åˆ—æ ‡é¢˜ä¸å¿…å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œä½†æ˜¯åˆ—ä¸­çš„å…ƒç´ å¿…é¡»å…·æœ‰ç›¸åŒçš„dtypeã€‚



æ­¤åŠŸèƒ½è¦æ±‚å…ƒç´ ä¸å…¶ä»–Seriesæˆ–DataFrameä¸­çš„å…ƒç´ å…·æœ‰ç›¸åŒçš„dtypeã€‚ ä½†æ˜¯ï¼Œåˆ—æ ‡ç­¾ä¸å¿…å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œåªè¦å®ƒä»¬ä»è¢«è§†ä¸ºç›¸ç­‰å³å¯ã€‚



```python
df = pd.DataFrame({1: [10], 2: [20]})
df
    1   2
0  10  20
```

DataFrames dfå’Œfully_equalçš„å…ƒç´ å’Œåˆ—æ ‡ç­¾å…·æœ‰ç›¸åŒçš„ç±»å‹å’Œå€¼ï¼Œå®ƒä»¬å°†è¿”å›Trueã€‚

```python
exactly_equal = pd.DataFrame({1: [10], 2: [20]})
exactly_equal
'''
    1   2
0  10  20
'''
df.equals(exactly_equal)
# True
```

DataFrames dfå’Œdifferent_column_typeå…·æœ‰ç›¸åŒçš„å…ƒç´ ç±»å‹å’Œå€¼ï¼Œä½†åˆ—æ ‡ç­¾å…·æœ‰ä¸åŒçš„ç±»å‹ï¼Œå®ƒä»¬ä»å°†è¿”å›Trueã€‚

```python
different_column_type = pd.DataFrame({1.0: [10], 2.0: [20]})
different_column_type
'''
   1.0  2.0
0   10   20
'''
df.equals(different_column_type)
# True
```

DataFrames dfå’Œdifferent_data_typeä¸ºå…¶å…ƒç´ çš„ç›¸åŒå€¼å…·æœ‰ä¸åŒçš„ç±»å‹ï¼Œå³ä½¿å®ƒä»¬çš„åˆ—æ ‡ç­¾å…·æœ‰ç›¸åŒçš„å€¼å’Œç±»å‹ï¼Œå®ƒä»¬ä¹Ÿå°†è¿”å›Falseã€‚

```python
different_data_type = pd.DataFrame({1: [10.0], 2: [20.0]})
different_data_type
'''
      1     2
0  10.0  20.0
'''
df.equals(different_data_type)
# False
```

### æ•°æ®å¯¹é½

DataFrame.align ä¸ä¼šç»„åˆä¸¤ä¸ªæ•°æ®å¸§ï¼Œä½†æ˜¯å¯ä»¥å°†å®ƒä»¬å¯¹é½ï¼Œä»¥ä¾¿ä¸¤ä¸ªæ•°æ®å¸§å…·æœ‰ç›¸åŒçš„è¡Œå’Œ/æˆ–åˆ—é…ç½®ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```python
df1 = pd.DataFrame([[1,2,3,4], [6,7,8,9]], 
                   columns=['D', 'B', 'E', 'A'],
                   index=[1,2])

df2 = pd.DataFrame([[10,20,30,40], [60,70,80,90], [600,700,800,900]],
                   columns=['A', 'B', 'C', 'D'],
                   index=[2,3,4])

df1
'''
   D  B  E  A
1  1  2  3  4
2  6  7  8  9
'''
df2
'''
     A    B    C    D
2   10   20   30   40
3   60   70   80   90
4  600  700  800  900
'''
```

è®©æˆ‘ä»¬å¯¹é½è¿™ä¸¤ä¸ªæ•°æ®å¸§ï¼ŒæŒ‰åˆ—å¯¹é½ï¼ˆaxis=1ï¼‰ï¼Œå¹¶å¯¹åˆ—æ ‡ç­¾æ‰§è¡Œå¤–éƒ¨è”æ¥ï¼ˆjoin='outer'ï¼‰ï¼š

```python
a1, a2 = df1.align(df2, join='outer', axis=1)
print(a1)
print(a2)
'''
   A  B   C  D  E
1  4  2 NaN  1  3
2  9  7 NaN  6  8

A    B    C    D   E
2   10   20   30   40 NaN
3   60   70   80   90 NaN
4  600  700  800  900 NaN
'''
```

è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- df1ä¸­çš„åˆ—å·²é‡æ–°æ’åˆ—ï¼Œä»¥ä¾¿ä¸df2ä¸­çš„åˆ—å¯¹é½ã€‚
- æœ‰ä¸€ä¸ªæ ‡è®°ä¸ºâ€œCâ€çš„åˆ—å·²æ·»åŠ åˆ°df1ï¼Œè¿˜æœ‰ä¸€ä¸ªæ ‡è®°ä¸ºâ€œEâ€çš„åˆ—å·²æ·»åŠ åˆ°df2ã€‚è¿™äº›åˆ—å·²ç”¨NaNå¡«å……ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¯¹åˆ—æ ‡ç­¾æ‰§è¡Œäº†å¤–éƒ¨è”æ¥ã€‚
- æ•°æ®å¸§å†…çš„æ‰€æœ‰å€¼å‡æœªæ›´æ”¹ã€‚
- è¡Œæ ‡ç­¾æœªå¯¹é½ï¼›df2æœ‰ç¬¬3è¡Œå’Œç¬¬4è¡Œï¼Œè€Œdf1æ²¡æœ‰ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¦æ±‚å¯¹åˆ—è¿›è¡Œå¯¹é½ï¼ˆè½´=1ï¼‰ã€‚

å¦‚æœæˆ‘ä»¬åœ¨è¡Œå’Œåˆ—ä¸Šå¯¹é½ï¼Œä½†å°†joinå‚æ•°æ›´æ”¹ä¸ºâ€œrightâ€ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ

```python
a1, a2 = df1.align(df2, join='right', axis=None)
print(a1)
print(a2)
'''
     A    B   C    D
2  9.0  7.0 NaN  6.0
3  NaN  NaN NaN  NaN
4  NaN  NaN NaN  NaN

     A    B    C    D
2   10   20   30   40
3   60   70   80   90
4  600  700  800  900
'''
```

æ€»ä¹‹ï¼Œå¦‚æœè¦ç¡®ä¿ä¸¤ä¸ªæ•°æ®å¸§ä¹‹é—´çš„è¡Œå’Œ/æˆ–åˆ—çš„æ’åˆ—ç›¸åŒï¼Œè€Œä¸æ”¹å˜ä¸¤ä¸ªæ•°æ®å¸§ä¸­åŒ…å«çš„ä»»ä½•æ•°æ®ï¼Œè¯·ä½¿ç”¨ DataFrame.align()ã€‚Series ä¹Ÿæ”¯æŒæ­¤æ–¹æ³•ã€‚

æ›´å¤šå†…å®¹æŸ¥çœ‹ï¼š[align()](https://www.gairuo.com/p/pandas-align) æ•°æ®å¯¹é½æ–¹æ³•ä»‹ç»ã€‚

